FROM ghcr.io/astral-sh/uv:python3.11-alpine

# Accept build arguments for environment variables
ARG ENV_MODE
ARG SUPABASE_URL
ARG SUPABASE_ANON_KEY
ARG SUPABASE_SERVICE_ROLE_KEY
ARG REDIS_HOST
ARG REDIS_PORT
ARG REDIS_PASSWORD
ARG REDIS_SSL
ARG ANTHROPIC_API_KEY
ARG OPENAI_API_KEY
ARG GROQ_API_KEY
ARG OPENROUTER_API_KEY
ARG GEMINI_API_KEY
ARG XAI_API_KEY
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_REGION_NAME
ARG OPENAI_COMPATIBLE_API_KEY
ARG OPENAI_COMPATIBLE_API_BASE
ARG RAPID_API_KEY
ARG TAVILY_API_KEY
ARG FIRECRAWL_API_KEY
ARG FIRECRAWL_URL
ARG DAYTONA_API_KEY
ARG DAYTONA_SERVER_URL
ARG DAYTONA_TARGET
ARG MCP_CREDENTIAL_ENCRYPTION_KEY
ARG TRIGGER_WEBHOOK_SECRET
ARG LANGFUSE_PUBLIC_KEY
ARG LANGFUSE_SECRET_KEY
ARG LANGFUSE_HOST
ARG STRIPE_SECRET_KEY
ARG STRIPE_WEBHOOK_SECRET
ARG STRIPE_DEFAULT_PLAN_ID
ARG STRIPE_DEFAULT_TRIAL_DAYS
ARG KORTIX_ADMIN_API_KEY
ARG COMPOSIO_API_KEY
ARG COMPOSIO_WEBHOOK_SECRET
ARG COMPOSIO_API_BASE
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG GOOGLE_REDIRECT_URI
ARG ZENDESK_AUTH_CONFIG
ARG EXA_API_KEY
ARG CHUNKR_API_KEY
ARG SUPABASE_WEBHOOK_SECRET
ARG SUPABASE_JWT_SECRET
ARG MAILTRAP_API_TOKEN
ARG MAILTRAP_SENDER_EMAIL
ARG MAILTRAP_SENDER_NAME

# Set environment variables
ENV ENV_MODE=$ENV_MODE
ENV SUPABASE_URL=$SUPABASE_URL
ENV SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
ENV SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY
ENV REDIS_HOST=$REDIS_HOST
ENV REDIS_PORT=$REDIS_PORT
ENV REDIS_PASSWORD=$REDIS_PASSWORD
ENV REDIS_SSL=$REDIS_SSL
ENV ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY
ENV OPENAI_API_KEY=$OPENAI_API_KEY
ENV GROQ_API_KEY=$GROQ_API_KEY
ENV OPENROUTER_API_KEY=$OPENROUTER_API_KEY
ENV GEMINI_API_KEY=$GEMINI_API_KEY
ENV XAI_API_KEY=$XAI_API_KEY
ENV AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
ENV AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
ENV AWS_REGION_NAME=$AWS_REGION_NAME
ENV OPENAI_COMPATIBLE_API_KEY=$OPENAI_COMPATIBLE_API_KEY
ENV OPENAI_COMPATIBLE_API_BASE=$OPENAI_COMPATIBLE_API_BASE
ENV RAPID_API_KEY=$RAPID_API_KEY
ENV TAVILY_API_KEY=$TAVILY_API_KEY
ENV FIRECRAWL_API_KEY=$FIRECRAWL_API_KEY
ENV FIRECRAWL_URL=$FIRECRAWL_URL
ENV DAYTONA_API_KEY=$DAYTONA_API_KEY
ENV DAYTONA_SERVER_URL=$DAYTONA_SERVER_URL
ENV DAYTONA_TARGET=$DAYTONA_TARGET
ENV MCP_CREDENTIAL_ENCRYPTION_KEY=$MCP_CREDENTIAL_ENCRYPTION_KEY
ENV TRIGGER_WEBHOOK_SECRET=$TRIGGER_WEBHOOK_SECRET
ENV LANGFUSE_PUBLIC_KEY=$LANGFUSE_PUBLIC_KEY
ENV LANGFUSE_SECRET_KEY=$LANGFUSE_SECRET_KEY
ENV LANGFUSE_HOST=$LANGFUSE_HOST
ENV STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY
ENV STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET
ENV STRIPE_DEFAULT_PLAN_ID=$STRIPE_DEFAULT_PLAN_ID
ENV STRIPE_DEFAULT_TRIAL_DAYS=$STRIPE_DEFAULT_TRIAL_DAYS
ENV KORTIX_ADMIN_API_KEY=$KORTIX_ADMIN_API_KEY
ENV COMPOSIO_API_KEY=$COMPOSIO_API_KEY
ENV COMPOSIO_WEBHOOK_SECRET=$COMPOSIO_WEBHOOK_SECRET
ENV COMPOSIO_API_BASE=$COMPOSIO_API_BASE
ENV GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
ENV GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
ENV GOOGLE_REDIRECT_URI=$GOOGLE_REDIRECT_URI
ENV ZENDESK_AUTH_CONFIG=$ZENDESK_AUTH_CONFIG
ENV EXA_API_KEY=$EXA_API_KEY
ENV CHUNKR_API_KEY=$CHUNKR_API_KEY
ENV SUPABASE_WEBHOOK_SECRET=$SUPABASE_WEBHOOK_SECRET
ENV SUPABASE_JWT_SECRET=$SUPABASE_JWT_SECRET
ENV MAILTRAP_API_TOKEN=$MAILTRAP_API_TOKEN
ENV MAILTRAP_SENDER_EMAIL=$MAILTRAP_SENDER_EMAIL
ENV MAILTRAP_SENDER_NAME=$MAILTRAP_SENDER_NAME

WORKDIR /app

RUN apk add --no-cache curl git \
    # Dependencies for Python package compilation
    freetype-dev \
    gcc \
    linux-headers \
    musl-dev \
    python3-dev

# Install Python dependencies
COPY pyproject.toml uv.lock ./
ENV UV_LINK_MODE=copy
RUN --mount=type=cache,target=/root/.cache/uv uv sync --locked --quiet

# Copy application code
COPY . .

# Calculate optimal worker count based on 16 vCPUs
# Using (2*CPU)+1 formula for CPU-bound applications
ENV WORKERS=7
ENV THREADS=2
ENV WORKER_CONNECTIONS=2000

ENV PYTHONPATH=/app
EXPOSE 8000

# Gunicorn configuration
CMD ["sh", "-c", "uv run gunicorn api:app \
  --workers $WORKERS \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000 \
  --timeout 1800 \
  --graceful-timeout 600 \
  --keep-alive 1800 \
  --max-requests 0 \
  --max-requests-jitter 0 \
  --forwarded-allow-ips '*' \
  --worker-connections $WORKER_CONNECTIONS \
  --worker-tmp-dir /dev/shm \
  --preload \
  --log-level info \
  --access-logfile - \
  --error-logfile - \
  --capture-output \
  --enable-stdio-inheritance \
  --threads $THREADS"]